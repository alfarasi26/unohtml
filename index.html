<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>UNO HTML VERSION by Renaldi Alfarasi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS untuk Layout dan Styling */
        :root {
            --card-width: 70px;
            --card-height: 105px;
            --hand-offset: -40px;
            --red: #c72a18;
            --yellow: #f6d83a;
            --green: #38a745;
            --blue: #007bff;
        }

        /* --- Pengaturan Dasar --- */
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            /* Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* IE10+/Edge */
        }

        body {
            background-color: #0c3b2e;
            font-family: 'Poppins', sans-serif;
            color: white;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }

        /* --- Layar & Kontainer --- */
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            background: radial-gradient(circle, #1e6b52, #0a5c3f);
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .hidden {
            display: none !important;
        }

        #game-wrapper {
            overflow: hidden;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 1400px;
            max-height: 900px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            background: radial-gradient(circle, #1e6b52, #0a5c3f);
        }

        /* --- Menu Utama & Tombol --- */
        .menu-title {
            font-size: clamp(2.5rem, 10vw, 4rem);
            text-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .menu-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            border-radius: 50px;
            border: 3px solid white;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }

        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        }

        .menu-btn.green {
            background-color: var(--green);
        }

        .menu-btn.red {
            background-color: var(--red);
        }

        .menu-btn.yellow {
            background-color: var(--yellow);
            color: black;
        }

        .menu-btn.blue {
            background-color: var(--blue);
        }

        /* --- Layar Nama & Skor --- */
        #player-name-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        #player-name-input {
            padding: 10px 15px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: 2px solid white;
            text-align: center;
        }

        #highscore-list {
            list-style: none;
            padding: 0 10px 0 20px;
            /* Beri ruang untuk scrollbar */
            margin: 0;
            font-size: 1.2rem;
            text-align: left;
            /* Ubah ke kiri agar lebih rapi */
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            /* --- PERUBAHAN UTAMA DIMULAI DI SINI --- */
            max-height: 40vh;
            /* Batasi tinggi maksimum (misalnya, 40% dari tinggi layar) */
            overflow-y: auto;
            /* Tambahkan scrollbar vertikal jika konten melebihi batas */
        }

        /* Styling agar scrollbar terlihat bagus */
        #highscore-list::-webkit-scrollbar {
            width: 10px;
        }

        #highscore-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        #highscore-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 10px;
        }

        #highscore-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        #highscore-list li {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        #highscore-list li:last-child {
            border-bottom: none;
        }

        #highscore-list .score {
            float: right;
            font-weight: 700;
        }

        /* --- Layar Pengaturan Permainan (BARU) --- */
        .setup-options {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 30px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .setup-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .setup-option label {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .setup-select {
            padding: 8px 15px;
            font-size: 1.1rem;
            font-family: 'Poppins', sans-serif;
            border-radius: 8px;
            border: 2px solid white;
            background-color: rgba(255, 255, 255, 0.9);
            color: black;
        }

        .setup-buttons {
            display: flex;
            gap: 20px;
        }

        /* --- Layar Akhir Game --- */
        #end-game-screen .menu-title {
            font-size: clamp(2rem, 8vw, 3rem);
            /* Ukuran judul diperkecil */
        }

        #end-game-ranks {
            width: 90%;
            /* Sedikit lebih lebar agar muat */
            max-width: 500px;
            text-align: center;
        }

        #end-game-ranks h3 {
            font-size: 1.5rem;
            /* Ukuran sub-judul diperkecil */
            margin-bottom: 15px;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            /* Padding diubah sedikit */
            font-size: 1.2rem;
            /* Ukuran font item peringkat diperkecil */
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .rank-item .rank-pos {
            font-weight: 700;
        }

        .end-game-options {
            display: flex;
            flex-wrap: wrap;
            /* Agar tombol tidak tumpang tindih di layar kecil */
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        /* --- Layar Petunjuk Permainan --- */
        .instructions-content {
            width: 90%;
            max-width: 700px;
            height: 60vh;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px 25px;
            overflow-y: auto;
            /* Penting untuk scrolling */
            text-align: left;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .instructions-content h3 {
            color: var(--yellow);
            margin-top: 20px;
            margin-bottom: 5px;
        }

        .instructions-content ul {
            padding-left: 20px;
        }

        .instructions-content li {
            margin-bottom: 5px;
        }

        .credits-section {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .credits-section p {
            margin: 2px 0;
        }

        /* --- Area Pemain --- */
        .player-area {
            position: absolute;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        #player-area-bottom {
            bottom: 5px;
            width: 100%;
            left: 0;
            flex-direction: column;
            justify-content: flex-end;
        }

        #player-area-top {
            top: 5px;
            width: 100%;
            left: 0;
            flex-direction: column;
            justify-content: flex-start;
        }

        #player-area-left {
            left: 5px;
            height: 100%;
            top: 0;
            flex-direction: row;
            justify-content: flex-start;
        }

        #player-area-right {
            right: 5px;
            height: 100%;
            top: 0;
            flex-direction: row-reverse;
            justify-content: flex-start;
        }

        /* --- Tangan Pemain --- */
        .hand {
            display: flex;
            position: relative;
        }

        #player-hand {
            padding-bottom: 10px;
            min-height: calc(var(--card-height) + 20px);
            display: flex;
            justify-content: center;
            align-items: flex-end;
            flex-wrap: wrap;
            /* Memungkinkan kartu turun ke baris baru jika tidak muat */
        }

        #player-area-top .hand {
            flex-direction: row;
            justify-content: center;
        }

        #player-area-left .hand,
        #player-area-right .hand {
            flex-direction: column;
            justify-content: center;
        }

        /* --- Styling Kartu --- */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            border-radius: 8px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: transform 0.3s ease, margin 0.3s ease;
            border: 2px solid white;
            background-clip: padding-box;
        }

        #player-hand .card {
            margin-left: var(--hand-offset);
        }

        #player-hand .card:first-child {
            margin-left: 0;
        }

        #player-hand .card:hover,
        #player-hand .card.selected {
            transform: translateY(-20px) scale(1.1);
            z-index: 100;
        }

        .bot-hand .card {
            margin-left: -55px;
        }

        #player-area-left .bot-hand .card,
        #player-area-right .bot-hand .card {
            margin-top: -90px;
            margin-left: 0;
        }

        .bot-hand .card:first-child {
            margin: 0;
        }

        .card-back {
            background-color: #1a1a1a;
        }

        .card-back::after {
            content: 'UNO';
            font-size: 20px;
            color: #ffc107;
            transform: rotate(-30deg);
        }

        .card[data-color="red"] {
            background-color: var(--red);
        }

        .card[data-color="yellow"] {
            background-color: var(--yellow);
        }

        .card[data-color="green"] {
            background-color: var(--green);
        }

        .card[data-color="blue"] {
            background-color: var(--blue);
        }

        .card[data-color="black"] {
            background: repeating-linear-gradient(45deg, var(--red) 0 15px, var(--yellow) 0 30px, var(--green) 0 45px, var(--blue) 0 60px);
        }

        /* --- Animasi --- */
        .card-animation {
            position: absolute;
            z-index: 999;
            transition: all 0.2s ease-in-out;
            /* (PERBAIKAN) Paksa hardware acceleration untuk animasi mulus */
            transform: translateZ(0);
            will-change: transform, top, left;
        }

        #action-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            font-size: 150px;
            z-index: 1100;
            opacity: 0;
            transition: all 0.5s ease;
            text-shadow: 0 0 20px black;
            text-align: center;
        }

        #action-indicator.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        #pre-game-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            z-index: 1100;
            text-shadow: 0 0 20px black;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
        }

        #pre-game-cards {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .pre-game-card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .player-name-label {
            font-size: 1rem;
            font-weight: 400;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* --- UI & Info Lainnya --- */
        #center-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 30px;
            align-items: center;
        }

        #deck-pile,
        #discard-pile-container {
            transition: transform 0.2s ease;
        }

        #deck-pile:hover {
            transform: scale(1.05);
        }

        #discard-pile-container {
            width: var(--card-width);
            height: var(--card-height);
            border: 3px dashed rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }

        #discard-pile-container.drag-over {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        #game-info {
            position: absolute;
            top: 34%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.1em;
            z-index: 500;
        }

        #notification {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s 1s, opacity 1s ease-in-out;
            position: absolute;
            top: 20px;
            /* DIUBAH: Menyamakan posisi vertikal dengan tombol pause */
            left: 75px;
            /* DIUBAH: Memberi jarak dari kiri, setelah tombol pause */
            transform: none;
            /* DIUBAH: Menghapus transform lama agar posisi pas */
            text-align: left;
            /* DIUBAH: Mengubah perataan teks menjadi kiri */
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.1em;
            z-index: 1500;
            max-width: 350px;
            /* DITAMBAHKAN: Membatasi lebar agar tidak terlalu panjang */
        }

        #notification.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        #uno-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 25px;
            font-size: 20px;
            font-weight: bold;
            background-color: #e74c3c;
            color: white;
            border: 3px solid white;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            visibility: hidden;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        #uno-button.visible {
            visibility: visible;
            opacity: 1;
            transform: scale(1);
        }

        #uno-button.visible:hover {
            transform: scale(1.1);
        }

        #uno-button.called {
            background-color: #2ecc71;
            transform: scale(1.1);
        }

        .player-info {
            background-color: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            margin: 10px;
        }

        .player-area.active .player-info {
            border-color: #ffc107;
            transform: scale(1.1);
            box-shadow: 0 0 15px #ffc107;
        }

        .player-area.finished .player-info {
            background-color: #555;
            opacity: 0.7;
        }

        /* --- Popup & Modal --- */
        .popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border-radius: 15px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            border: 2px solid white;
        }

        .popup h3 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
        }

        .popup-options {
            display: flex;
            gap: 15px;
            width: 100%;
        }

        .popup-btn {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: 2px solid white;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-family: 'Poppins';
        }

        .color-btn {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        #direction-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        #direction-arrow {
            font-size: 24px;
            transition: transform 0.5s ease;
        }

        #pause-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(0, 0, 0, 0.6);
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: white;
            z-index: 1500;
        }

        /* --- (PERBAIKAN) Styling & Animasi untuk Layar Pembuka --- */
        #splash-screen {
            cursor: pointer;
            /* SAMAKAN background dengan .screen agar konsisten */
            background: radial-gradient(circle, #1e6b52, #0a5c3f);
        }

        #splash-cards-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            /* TURUNKAN posisi kartu dari atas layar */
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
        }

        .splash-card {
            width: 80px;
            height: 120px;
            opacity: 0;
            transform: scale(0);
        }

        /* Animasi Pop In */
        .pop-in {
            animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }

        @keyframes pop-in {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Hapus .pop-out yang lama, kita akan pakai .fade-out */

        #splash-title {
            font-size: clamp(5rem, 20vw, 10rem);
            text-shadow: 5px 5px 10px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateY(-100vh);
        }

        /* Animasi Slide Down */
        .slide-down {
            animation: slide-down 2s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        @keyframes slide-down {
            to {
                opacity: 1;
                transform: translateY(-40px);
            }
        }

        #splash-prompt {
            position: absolute;
            bottom: 20px;
            left: 50%;
            /* TAMBAHKAN INI untuk memulai dari tengah */
            transform: translateX(-50%);
            /* TAMBAHKAN INI untuk memusatkan dengan sempurna */
            font-size: 1.2rem;
            opacity: 0;
        }

        /* Animasi Fade In & Out Universal */
        .fade-in {
            animation: fade-in 1s ease forwards;
        }

        @keyframes fade-in {
            to {
                opacity: 1;
            }
        }

        .fade-out {
            animation: fade-out 1s ease forwards;
        }

        @keyframes fade-out {
            to {
                opacity: 0;
            }
        }

        /* (TAMBAHKAN INI) CSS untuk Wadah Teks yang Hilang */
        #splash-text-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
        }

        /* ========================================================================= */
        /* (PERBAIKAN DEFINITIF) Pengaturan Kursor di Seluruh Game                   */
        /* ========================================================================= */

        /* Langkah 1: Paksa kursor default untuk semua elemen dasar */
        body,
        .screen,
        #game-container,
        #game-wrapper,
        #center-area {
            cursor: default !important;
        }

        /* Langkah 2: Beri kursor pointer HANYA pada elemen yang benar-benar bisa diklik */
        .menu-btn,
        #player-hand .card,
        #deck-pile,
        #uno-button,
        #pause-btn,
        .popup-btn,
        .color-btn,
        .setup-select {
            cursor: pointer;
        }

        /* Langkah 3: Kasus khusus untuk layar pembuka yang bisa diklik di mana saja */
        #splash-screen {
            cursor: pointer;
        }

        /* Penyesuaian untuk layar mobile yang lebih kecil */
        @media (max-width: 480px) {
            .splash-card {
                width: 60px;
                height: 90px;
            }

            #splash-cards-container {
                gap: 10px;
            }
        }

        /* (PERBAIKAN) Persiapkan elemen menu utama untuk animasi pop-in */
        #main-menu-screen .menu-title,
        #main-menu-screen .menu-btn {
            opacity: 0;
            /* TAMBAHAN PENTING: Atur ukuran awal agar animasi pop-in bekerja */
            transform: scale(0.5);
            animation-fill-mode: forwards;
        }

        /* ========================================================================= */
        /* ATURAN CSS KHUSUS UNTUK TAMPILAN MOBILE VERTIKAL (VERSI BARU)             */
        /* ========================================================================= */
        @media (max-width: 768px) and (orientation: portrait) {

            /* -- Variabel Ukuran untuk Mobile -- */
            :root {
                --card-width: 48px;
                --card-height: 72px;
                --hand-offset: -32px;
            }

            /* --- Penyesuaian Layar Menu & Pengaturan --- */
            .screen {
                padding: 10px;
                /* Beri padding agar konten tidak menempel di tepi */
            }

            #game-setup-screen .menu-title {
                font-size: clamp(1.8rem, 8vw, 2.5rem);
                /* Perkecil judul */
                margin-top: 20px;
                margin-bottom: 0;
            }

            .setup-options {
                transform: scale(0.9);
                /* Perkecil seluruh kotak opsi */
                margin-bottom: 5px;
            }

            .setup-buttons {
                transform: scale(0.9);
                /* Perkecil tombol bawah */
                gap: 10px;
            }

            /* --- (PERBAIKAN) Perkecil tombol khusus di layar pengaturan --- */
            #game-setup-screen .menu-btn {
                padding: 10px 25px;
                font-size: 1.1rem;
            }

            /* --- (PERBAIKAN) Penyesuaian layar Pra-Game --- */
            #pre-game-info {
                width: 90%;
                /* Batasi lebar agar tidak keluar layar */
                padding: 15px;
                /* Menggabungkan translate & scale agar tetap di tengah */
                transform: translate(-50%, -50%) scale(0.9);
            }

            #pre-game-info h3 {
                font-size: 1.5rem;
                /* Perkecil judul */
                margin-bottom: 10px;
            }

            #pre-game-cards {
                gap: 10px;
                /* Kurangi jarak antar kartu */
                transform: scale(0.95);
                /* Perkecil area kartu */
            }

            #pre-game-info p {
                font-size: 1.1rem;
                /* Perkecil tulisan pemenang */
            }

            /* -- Penyesuaian Area Pemain -- */
            #player-area-bottom {
                bottom: 10px;
            }

            #player-area-left,
            #player-area-right {
                top: 55%;
                transform: translateY(-50%);
                height: auto;
                align-items: center;
                /* Pusatkan item secara vertikal */
                gap: 5px;
                /* Beri sedikit jarak antara kartu & nama */
            }

            /* 1. Atur Posisi Pemain Kiri & Kanan */
            #player-area-left {
                left: 5px;
                flex-direction: row;
            }

            #player-area-left .player-info {
                order: 2;
            }

            #player-area-left .hand {
                order: 1;
            }

            #player-area-right {
                right: 5px;
                flex-direction: row-reverse;
            }

            #player-area-right .player-info {
                order: 2;
            }

            #player-area-right .hand {
                order: 1;
            }

            #player-area-left .bot-hand .card,
            #player-area-right .bot-hand .card {
                margin-top: -60px;
            }

            #player-hand {
                padding-bottom: 5px;
                padding-left: 20px;
                padding-right: 20px;
            }

            /* -- Penyesuaian Elemen Tengah & Info -- */
            #center-area {
                gap: 15px;
                top: 45%;
            }

            #game-info {
                top: 32%;
                /* Sesuaikan posisi info giliran */
                padding: 5px 10px;
                font-size: 0.9em;
                max-width: 80%;
            }

            /* 2. Atur Indikator Arah Panah */
            #direction-indicator {
                top: 15px;
                right: 15px;
                bottom: auto;
                transform: none;
                padding: 8px;
                /* Perkecil padding karena hanya panah */
            }

            #direction-indicator #direction-text {
                display: none;
                /* Sembunyikan teks */
            }

            #direction-arrow {
                font-size: 1.5em;
                /* Perbesar sedikit panahnya agar jelas */
                margin: 0;
            }

            /* 3. Atur Posisi Notifikasi */
            #notification {
                top: auto;
                bottom: 145px;
                /* Posisikan di atas tangan pemain */
                left: 50%;
                transform: translateX(-50%);
                text-align: center;
                max-width: 80vw;
                padding: 8px 15px;
                font-size: 0.9em;
            }

            /* -- Penyesuaian Tombol -- */
            #uno-button {
                bottom: 150px;
                right: 15px;
                /* Posisikan ke kanan */
                left: auto;
                /* Hapus posisi kiri */
                transform: none;
                /* Hapus pemusatan horizontal */
                padding: 8px 20px;
                font-size: 1em;
            }

            #pause-btn {
                top: 10px;
                left: 10px;
            }

            /* -- Penyesuaian Elemen Lainnya -- */
            .player-info {
                padding: 4px 8px;
                font-size: 0.8em;
                margin: 0;
            }

            .popup h3 {
                font-size: 1.5rem;
            }

            .popup-btn,
            .color-btn {
                transform: scale(0.9);
            }

            /* --- Penyesuaian Semua Pop-up --- */
            .popup {
                width: 90%;
            }

            .popup h3 {
                font-size: 1.5rem;
            }

            .popup-btn,
            .color-btn {
                transform: scale(0.9);
            }

            /* --- (PERBAIKAN TERAKHIR) Penyesuaian Pop-up Tantangan +4 --- */
            #challenge-popup .popup-options {
                flex-direction: column;
                /* Tumpuk tombol secara vertikal */
                width: 100%;
                gap: 10px;
            }

            #challenge-popup .menu-btn {
                width: 100%;
                /* Buat tombol selebar pop-up */
                padding: 12px 10px;
                font-size: 1rem;
            }

            /* (TAMBAHKAN INI) Penyesuaian Pop-up Konfirmasi Keluar di Mobile */
            #exit-confirmation-popup .popup-options {
                flex-direction: row;
                /* Pastikan tombol berdampingan di mobile juga */
                justify-content: center;
            }

            #exit-confirmation-popup .menu-btn {
                padding: 10px 30px;
                /* Sesuaikan ukuran tombol agar muat */
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>

    <!-- (TAMBAHKAN INI) Layar Animasi Pembuka -->
    <div id="splash-screen" class="screen">
        <div id="splash-cards-container">
            <!-- Kartu akan dibuat oleh JavaScript -->
        </div>

        <div id="splash-text-container">
            <h1 id="splash-title">UNO</h1>
            <p id="splash-prompt">Tekan layar untuk melanjutkan</p>
        </div>

        <!-- Layar Menu Utama -->
        <div id="main-menu-screen" class="screen">
            <h1 class="menu-title">UNO</h1>
            <button id="start-game-btn" class="menu-btn green">Mulai Game</button>
            <button id="how-to-play-btn" class="menu-btn blue">Petunjuk Permainan</button>
            <button id="highscore-btn" class="menu-btn yellow">High Score</button>
            <button id="exit-btn" class="menu-btn red">Keluar</button>
        </div>

        <!-- Layar Input Nama -->
        <div id="player-name-screen" class="screen hidden">
            <h2 class="menu-title">Masukkan Nama Anda</h2>
            <form id="player-name-form">
                <input type="text" id="player-name-input" maxlength="15" required placeholder="Nama Pemain">
                <button type="submit" class="menu-btn green">Lanjutkan</button>
            </form>
            <button id="back-to-menu-from-name" class="menu-btn red">Kembali</button>
        </div>

        <!-- Layar Pengaturan Permainan (BARU) -->
        <div id="game-setup-screen" class="screen hidden">
            <h2 class="menu-title">Pengaturan Permainan</h2>
            <div class="setup-options">
                <div class="setup-option">
                    <label for="difficulty-select">Tingkat Kesulitan Bot:</label>
                    <select id="difficulty-select" class="setup-select">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                        <option value="expert">Expert</option>
                    </select>
                </div>
                <div class="setup-option">
                    <label for="player-count-select">Jumlah Pemain:</label>
                    <select id="player-count-select" class="setup-select">
                        <option value="2">2 Pemain</option>
                        <option value="3">3 Pemain</option>
                        <option value="4" selected>4 Pemain</option>
                    </select>
                </div>
            </div>
            <div class="setup-buttons">
                <button id="start-pre-game-btn" class="menu-btn green">Lanjutkan</button>
                <button id="back-to-name-btn" class="menu-btn red">Kembali</button>
            </div>
        </div>

        <!-- Layar High Score -->
        <div id="highscore-screen" class="screen hidden">
            <h2 class="menu-title">High Score</h2>
            <ul id="highscore-list"></ul>
            <button id="back-to-menu-from-hs" class="menu-btn red">Kembali</button>
        </div>

        <!-- Layar Petunjuk Permainan -->
        <div id="how-to-play-screen" class="screen hidden">
            <h2 class="menu-title">Petunjuk Permainan</h2>
            <div class="instructions-content">
                <h3>Tujuan Permainan</h3>
                <p>Jadilah pemain pertama yang menghabiskan semua kartu di tangan Anda.</p>

                <h3>Memulai Permainan</h3>
                <p>Setiap pemain dibagikan 7 kartu. Sisa kartu diletakkan tertutup sebagai Dek Ambil. Kartu teratas dari
                    Dek
                    Ambil dibalik untuk memulai Tumpukan Buang.</p>

                <h3>Cara Bermain</h3>
                <p>Pemain pertama harus mencocokkan kartu di Tumpukan Buang berdasarkan Angka, Warna, atau Simbol.
                    Contohnya, jika kartu di Tumpukan Buang adalah Biru 7, Anda harus mengeluarkan kartu Biru atau kartu
                    7
                    dengan warna apa pun.</p>
                <p>Jika Anda tidak memiliki kartu yang cocok, Anda harus mengambil satu kartu dari Dek Ambil. Jika kartu
                    yang baru diambil bisa dimainkan, Anda boleh langsung memainkannya. Jika tidak, giliran beralih ke
                    pemain berikutnya.</p>

                <h3>Kartu Aksi</h3>
                <ul>
                    <li><strong>Kartu Lewati (Skip):</strong> Pemain berikutnya kehilangan gilirannya.</li>
                    <li><strong>Kartu Putar Balik (Reverse):</strong> Arah permainan berbalik.</li>
                    <li><strong>Kartu Ambil Dua (+2):</strong> Pemain berikutnya harus mengambil 2 kartu dan kehilangan
                        gilirannya.</li>
                    <li><strong>Kartu Wild:</strong> Pemain yang mengeluarkan kartu ini dapat memilih warna selanjutnya.
                    </li>
                    <li><strong>Kartu Wild Ambil Empat (+4):</strong> Pemain memilih warna selanjutnya, dan pemain
                        berikutnya harus mengambil 4 kartu serta kehilangan gilirannya. Kartu ini hanya boleh dimainkan
                        jika
                        Anda tidak memiliki kartu lain yang cocok dengan WARNA di Tumpukan Buang.</li>
                </ul>

                <h3>Menang</h3>
                <p>Saat Anda hanya memiliki satu kartu tersisa, Anda harus menekan tombol "UNO!". Jika lupa dan pemain
                    lain
                    menyadarinya, Anda harus mengambil 2 kartu sebagai penalti. Pemain pertama yang berhasil
                    menghabiskan
                    kartunya adalah pemenangnya.</p>

                <h3>Kontrol</h3>
                <p>Cukup drag and drop kartu yang udah dipilih ke bagian tumpukan buang. Untuk mengambil kartu
                    dalam dek cukup dengan menekan kartu yang terbalik di bagian tengah.</p>

                <h3>Auto Mode</h3>
                <p>Kalau kamu capek karena gamenya gak selesai-selesai, cukup tekan pause dan aktifkan Auto Mode, maka
                    gameplaymu
                    akan berjalan secara otomatis.</p>

                <hr>

                <div class="credits-section">
                    <p><strong>CREDITS:</p>
                    
                    <p><strong>UNO HTML VERSION v1.5</p>
                    <p><strong>Developed by:</strong> Renaldi Alfarasi</p>
                    <p><strong>Instagram:</strong> rnd_savage</p>
                    <p><strong>Youtube:</strong> RenaldiTV</p>
                    <br>
                    <p><em>UNO® is a trademark of Mattel, Inc. © Mattel, Inc. All Rights Reserved. This is a fan-made
                            project and is not affiliated with, endorsed by, or sponsored by Mattel, Inc.</em></p>
                </div>
            </div>
            <button id="back-to-menu-from-htp" class="menu-btn red">Kembali</button>
        </div>

        <!-- Kontainer Game (Wrapper) -->
        <div id="game-wrapper" class="screen hidden">
            <div id="pre-game-info" class="hidden"></div>
            <div id="game-container" class="hidden">
                <button id="pause-btn">||</button>
                <div id="direction-indicator">
                    <span id="direction-text"></span>
                    <span id="direction-arrow"></span>
                </div>
                <div id="action-indicator"></div>

                <!-- Area Pemain -->
                <div id="player-area-top" class="player-area">
                    <div class="player-info" id="info-bot-2"></div>
                    <div class="hand bot-hand" id="hand-bot-2"></div>
                </div>
                <div id="player-area-left" class="player-area">
                    <div class="player-info" id="info-bot-1"></div>
                    <div class="hand bot-hand" id="hand-bot-1"></div>
                </div>
                <div id="player-area-right" class="player-area">
                    <div class="player-info" id="info-bot-3"></div>
                    <div class="hand bot-hand" id="hand-bot-3"></div>
                </div>
                <div id="player-area-bottom" class="player-area">
                    <button id="uno-button">UNO!</button>
                    <div class="hand" id="player-hand"></div>
                    <div class="player-info" id="info-player"></div>
                </div>

                <!-- Area Tengah -->
                <div id="center-area">
                    <div id="deck-pile" class="card card-back"></div>
                    <div id="discard-pile-container"></div>
                </div>

                <div id="game-info"></div>
                <div id="notification"></div>
            </div>
        </div>

        <!-- Layar Akhir Game -->
        <div id="end-game-screen" class="screen hidden">
            <h2 class="menu-title">Permainan Selesai!</h2>
            <div id="end-game-ranks"></div>
            <div class="end-game-options">
                <button id="restart-game-btn" class="menu-btn green">Main Lagi</button>
                <button id="back-to-menu-from-end" class="menu-btn red">Kembali ke Menu</button>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // =========================================================================
                //  KONSTANTA & STATE GAME
                // =========================================================================
                const COLORS = ['red', 'yellow', 'green', 'blue'];
                const VALUES = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'skip', 'reverse', 'draw2'];
                const SPECIAL_VALUES = ['wild', 'wild4'];
                let NUM_PLAYERS = 4; // Diubah dari const menjadi let
                const CARDS_PER_PLAYER = 7;
                let botDifficulty = 'medium'; // Variabel baru untuk kesulitan
                const HIGHSCORE_KEY = 'unoHighScores';

                let deck = [];
                let discardPile = [];
                let players = [];
                let currentPlayerIndex = 0;
                let gameDirection = 1; // 1 for clockwise, -1 for counter-clockwise
                let gameActive = false;
                let unoCalledByPlayer = false;
                let isPaused = false;
                let playerRanks = [];
                let mainPlayerName = 'Pemain';
                let botTurnTimeout;
                let draggedElement = null; // Elemen yang sedang di-drag via sentuhan
                let draggedCardData = null; // Data kartu yang di-drag
                let ghostCard = null; // Kartu "hantu" yang mengikuti jari
                let isAutoMode = false;
                let touchedCardElement = null; // Kartu yang sedang disentuh/dipilih

                // =========================================================================
                //  SELEKTOR ELEMEN DOM
                // =========================================================================
                const screens = {
                    mainMenu: document.getElementById('main-menu-screen'),
                    name: document.getElementById('player-name-screen'),
                    gameSetup: document.getElementById('game-setup-screen'),
                    highscore: document.getElementById('highscore-screen'),
                    howToPlay: document.getElementById('how-to-play-screen'),
                    game: document.getElementById('game-wrapper'),
                    endGame: document.getElementById('end-game-screen'),
                };
                const gameContainer = document.getElementById('game-container');
                const playerHandElem = document.getElementById('player-hand');
                const deckPileElem = document.getElementById('deck-pile');
                const discardPileContainer = document.getElementById('discard-pile-container');
                const gameInfoElem = document.getElementById('game-info');
                const unoButton = document.getElementById('uno-button');
                const notificationElem = document.getElementById('notification');
                const actionIndicatorElem = document.getElementById('action-indicator');
                const directionTextElem = document.getElementById('direction-text');
                const directionArrowElem = document.getElementById('direction-arrow');
                const preGameInfoElem = document.getElementById('pre-game-info');

                // =========================================================================
                //  FUNGSI UTILITAS
                // =========================================================================
                const showScreen = (screenName) => {
                    Object.values(screens).forEach(s => s.classList.add('hidden'));
                    screens[screenName].classList.remove('hidden');
                };

                const showNotification = (msg, duration = 2500) => {
                    notificationElem.textContent = msg;
                    notificationElem.classList.add('show');
                    setTimeout(() => notificationElem.classList.remove('show'), duration);
                };

                const showAction = (symbol) => {
                    actionIndicatorElem.textContent = symbol;
                    actionIndicatorElem.classList.add('show');
                    setTimeout(() => actionIndicatorElem.classList.remove('show'), 1000);
                };

                const updateDirectionIndicator = () => {
                    directionTextElem.textContent = gameDirection === 1 ? 'Searah Jarum Jam' : 'Berlawanan Arah';
                    directionArrowElem.innerHTML = gameDirection === 1 ? '&#8641;' : '&#8640;'; // Arrows
                    directionArrowElem.style.transform = `scaleX(${gameDirection})`;
                };

                const getTopCard = () => discardPile[discardPile.length - 1];

                const isValidMove = (card, topCard) => {
                    if (!topCard) return true; // First card on discard pile
                    return card.color === 'black' || card.color === topCard.color || card.value === topCard.value;
                };

                const playerHasValidMove = (playerIndex) => {
                    const player = players.find(p => p.id === playerIndex);
                    if (!player) return false;
                    const topCard = getTopCard();
                    return player.hand.some(card => isValidMove(card, topCard));
                };

                // =========================================================================
                //  LOGIKA MENU & HIGH SCORE
                // =========================================================================
                function initMenus() {
                    // --- Tombol Menu Utama ---
                    document.getElementById('start-game-btn').onclick = () => showScreen('name');
                    document.getElementById('how-to-play-btn').onclick = () => showScreen('howToPlay');
                    document.getElementById('highscore-btn').onclick = () => {
                        displayHighScores();
                        showScreen('highscore');
                    };
                    document.getElementById('exit-btn').onclick = showExitConfirmation;

                    // --- Alur Layar Nama -> Pengaturan ---
                    document.getElementById('player-name-form').onsubmit = (e) => {
                        e.preventDefault();
                        mainPlayerName = document.getElementById('player-name-input').value.trim() || 'Pemain';
                        showScreen('gameSetup'); // Pindah ke layar pengaturan, BUKAN langsung mulai game
                    };
                    document.getElementById('back-to-menu-from-name').onclick = () => showScreen('mainMenu');

                    // --- Alur Layar Pengaturan -> Mulai Game ---
                    document.getElementById('start-pre-game-btn').onclick = () => {
                        // Ambil nilai dari dropdown
                        botDifficulty = document.getElementById('difficulty-select').value;
                        NUM_PLAYERS = parseInt(document.getElementById('player-count-select').value);
                        startPreGame(); // Mulai game dengan pengaturan baru
                    };
                    document.getElementById('back-to-name-btn').onclick = () => showScreen('name');


                    // --- Tombol Kembali Lainnya ---
                    document.getElementById('back-to-menu-from-hs').onclick = () => showScreen('mainMenu');
                    document.getElementById('back-to-menu-from-htp').onclick = () => showScreen('mainMenu');
                    document.getElementById('restart-game-btn').onclick = startPreGame;
                    document.getElementById('back-to-menu-from-end').onclick = () => showScreen('mainMenu');
                    document.getElementById('pause-btn').onclick = togglePause;
                }

                function getHighScores() {
                    try {
                        const scores = localStorage.getItem(HIGHSCORE_KEY);
                        return scores ? JSON.parse(scores) : [];
                    } catch (e) {
                        console.error("Could not parse high scores from localStorage", e);
                        return [];
                    }
                }

                function saveHighScore(name, score) {
                    let scores = getHighScores();
                    scores.push({ name, score });
                    scores.sort((a, b) => b.score - a.score);
                    scores = scores.slice(0, 10); // Keep only top 10
                    localStorage.setItem(HIGHSCORE_KEY, JSON.stringify(scores));
                }

                function displayHighScores() {
                    const scores = getHighScores();
                    const list = document.getElementById('highscore-list');
                    if (scores.length > 0) {
                        list.innerHTML = scores.map((s, i) => `<li>#${i + 1} ${s.name} <span class="score">${s.score}</span></li>`).join('');
                    } else {
                        list.innerHTML = '<li>Belum ada skor tinggi.</li>';
                    }
                }

                function startSplashAnimation() {
                    const splashScreen = document.getElementById('splash-screen');
                    const cardsContainer = document.getElementById('splash-cards-container');
                    const splashTextContainer = document.getElementById('splash-text-container');
                    const splashTitle = document.getElementById('splash-title');
                    const splashPrompt = document.getElementById('splash-prompt');

                    const cardData = [
                        { color: 'red', value: '1' },
                        { color: 'blue', value: '2' },
                        { color: 'green', value: '3' },
                        { color: 'yellow', value: '4' }
                    ];

                    Object.values(screens).forEach(s => s.classList.add('hidden'));
                    splashScreen.classList.remove('hidden');

                    // 1. Animasi kartu muncul
                    cardData.forEach((card, index) => {
                        setTimeout(() => {
                            const cardEl = createCardElement(card);
                            cardEl.classList.add('splash-card', 'pop-in');
                            cardsContainer.appendChild(cardEl);
                        }, index * 1000);
                    });

                    // 2. Animasi KARTU menghilang
                    setTimeout(() => {
                        cardsContainer.classList.add('fade-out');
                    }, 5000);

                    // 3. Animasi TULISAN "UNO" turun
                    setTimeout(() => {
                        splashTitle.classList.add('slide-down');
                    }, 6000); // 1 detik setelah kartu mulai hilang

                    // 4. Animasi PROMPT "Tekan layar" muncul
                    setTimeout(() => {
                        splashPrompt.classList.add('fade-in');

                        // 5. Event listener untuk melanjutkan ke menu
                        function proceedToMenu() {
                            splashScreen.removeEventListener('click', proceedToMenu);
                            splashScreen.removeEventListener('touchstart', proceedToMenu);

                            // Animasikan WADAH TULISAN agar keduanya hilang bersamaan
                            splashTextContainer.classList.add('fade-out');

                            setTimeout(() => {
                                showScreen('mainMenu');
                                // Panggil fungsi animasi menu yang baru kita buat
                                animateMainMenu();
                            }, 1000);;
                        }

                        splashScreen.addEventListener('click', proceedToMenu);
                        splashScreen.addEventListener('touchstart', proceedToMenu);

                    }, 8000); // 2 detik setelah slide-down dimulai
                }

                function animateMainMenu() {
                    const menuScreen = screens.mainMenu;
                    const menuItems = [
                        menuScreen.querySelector('.menu-title'),
                        ...menuScreen.querySelectorAll('.menu-btn')
                    ];

                    menuItems.forEach((item, index) => {
                        if (item) {
                            item.style.animationDelay = `${index * 0.2}s`;
                            item.classList.add('pop-in');
                        }
                    });
                }

                // =========================================================================
                //  LOGIKA KARTU & DEK
                // =========================================================================
                function createDeck() {
                    const newDeck = [];
                    // Number cards
                    COLORS.forEach(color => {
                        VALUES.forEach(value => {
                            newDeck.push({ color, value });
                            if (value !== '0') { // Each color has two of each card from 1-9 and action cards
                                newDeck.push({ color, value });
                            }
                        });
                    });
                    // Wild cards
                    for (let i = 0; i < 4; i++) {
                        newDeck.push({ color: 'black', value: 'wild' });
                        newDeck.push({ color: 'black', value: 'wild4' });
                    }
                    return newDeck;
                }

                function shuffleDeck(deckToShuffle) {
                    for (let i = deckToShuffle.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [deckToShuffle[i], deckToShuffle[j]] = [deckToShuffle[j], deckToShuffle[i]];
                    }
                }

                // =========================================================================
                //  ALUR PERMAINAN (PRE-GAME, START, END)
                // =========================================================================
                /**
                 * [FIXED] Merombak total cara pemain dibuat.
                 * Sekarang, `players` hanya berisi pemain yang aktif.
                 * Properti `id` pada setiap objek bot sekarang secara konsisten merujuk pada slot visualnya
                 * (1=kiri, 2=atas, 3=kanan), yang memperbaiki bug animasi.
                 */
                function resetGameState() {
                    deck = [];
                    discardPile = [];
                    gameActive = false;
                    gameDirection = 1;
                    playerRanks = [];
                    unoCalledByPlayer = false;
                    isPaused = false;
                    isAutoMode = false;

                    const activePlayers = [];
                    let botCounter = 1; // Counter untuk penamaan bot yang sekuensial

                    // Player 0 (Manusia) selalu dibuat
                    activePlayers.push({ id: 0, name: mainPlayerName, hand: [], isBot: false, isFinished: false, unoCalled: false });

                    // Bot dibuat berdasarkan NUM_PLAYERS dan ID slot visual, tapi nama disesuaikan
                    if (NUM_PLAYERS === 2) {
                        // Slot 2 (Atas), Nama: Bot 1
                        activePlayers.push({ id: 2, name: `Bot ${botCounter++}`, hand: [], isBot: true, isFinished: false, unoCalled: false });
                    } else if (NUM_PLAYERS === 3) {
                        // Slot 1 (Kiri), Nama: Bot 1
                        activePlayers.push({ id: 1, name: `Bot ${botCounter++}`, hand: [], isBot: true, isFinished: false, unoCalled: false });
                        // Slot 3 (Kanan), Nama: Bot 2
                        activePlayers.push({ id: 3, name: `Bot ${botCounter++}`, hand: [], isBot: true, isFinished: false, unoCalled: false });
                    } else if (NUM_PLAYERS === 4) {
                        // Slot 1 (Kiri), Nama: Bot 1
                        activePlayers.push({ id: 1, name: `Bot ${botCounter++}`, hand: [], isBot: true, isFinished: false, unoCalled: false });
                        // Slot 2 (Atas), Nama: Bot 2
                        activePlayers.push({ id: 2, name: `Bot ${botCounter++}`, hand: [], isBot: true, isFinished: false, unoCalled: false });
                        // Slot 3 (Kanan), Nama: Bot 3
                        activePlayers.push({ id: 3, name: `Bot ${botCounter++}`, hand: [], isBot: true, isFinished: false, unoCalled: false });
                    }

                    players = activePlayers;

                    document.querySelectorAll('.player-area').forEach(el => el.classList.remove('finished'));
                }

                function setupPlayerLayout() {
                    const topArea = document.getElementById('player-area-top');
                    const leftArea = document.getElementById('player-area-left');
                    const rightArea = document.getElementById('player-area-right');

                    // Sembunyikan semua area bot terlebih dahulu
                    topArea.classList.add('hidden');
                    leftArea.classList.add('hidden');
                    rightArea.classList.add('hidden');

                    if (NUM_PLAYERS === 2) {
                        topArea.classList.remove('hidden');
                    } else if (NUM_PLAYERS === 3) {
                        leftArea.classList.remove('hidden');
                        rightArea.classList.remove('hidden');
                    } else if (NUM_PLAYERS === 4) {
                        topArea.classList.remove('hidden');
                        leftArea.classList.remove('hidden');
                        rightArea.classList.remove('hidden');
                    }
                }

                function startPreGame() {
                    showScreen('game');
                    gameContainer.classList.add('hidden');
                    preGameInfoElem.classList.remove('hidden');

                    resetGameState();
                    preGameInfoElem.innerHTML = `<h3>Menentukan Giliran Pertama...</h3><div id="pre-game-cards"></div>`;

                    // --- LOGIKA BARU UNTUK KARTU UNIK (VERSI ALTERNATIF) ---
                    // Logika ini menjamin setiap pemain mendapat angka yang berbeda.
                    const drawnCards = [];
                    const usedNumbers = new Set(); // Menggunakan Set untuk menyimpan angka yang sudah terpakai

                    // Terus menerus mengambil angka acak sampai jumlah angka unik sama dengan jumlah pemain.
                    while (usedNumbers.size < players.length) {
                        const randomNumber = Math.floor(Math.random() * 10).toString();
                        usedNumbers.add(randomNumber); // Set secara otomatis menolak nilai duplikat.
                    }

                    const uniqueNumbersArray = Array.from(usedNumbers);

                    // Bagikan angka unik yang sudah didapat kepada setiap pemain.
                    for (let i = 0; i < players.length; i++) {
                        const value = uniqueNumbersArray[i];
                        const color = COLORS[Math.floor(Math.random() * COLORS.length)];
                        drawnCards.push({ value, color });
                    }
                    // --- AKHIR LOGIKA BARU ---

                    const preGameCardsContainer = document.getElementById('pre-game-cards');
                    preGameCardsContainer.innerHTML = '';
                    drawnCards.forEach((card, index) => {
                        const cardContainer = document.createElement('div');
                        cardContainer.className = 'pre-game-card-container';
                        cardContainer.innerHTML = `<p class="player-name-label">${players[index].name}</p>`;
                        cardContainer.appendChild(createCardElement(card));
                        preGameCardsContainer.appendChild(cardContainer);
                    });

                    setTimeout(() => {
                        const highestCard = drawnCards.reduce((prev, current, index) => {
                            const currentValue = parseInt(current.value);
                            if (currentValue > prev.value) {
                                return { value: currentValue, index: index };
                            }
                            return prev;
                        }, { value: -1, index: -1 });

                        const startingPlayer = players[highestCard.index];
                        preGameInfoElem.innerHTML += `<p>${startingPlayer.name} mendapat giliran pertama!</p>`;

                        setTimeout(() => {
                            preGameInfoElem.classList.add('hidden');
                            gameContainer.classList.remove('hidden');
                            startGame(startingPlayer.id);
                        }, 2500);
                    }, 1500);
                }

                function startGame(startIdx) {
                    setupPlayerLayout();
                    // `resetGameState` sudah dipanggil di `startPreGame`, tidak perlu dipanggil lagi
                    currentPlayerIndex = startIdx;
                    updateDirectionIndicator();

                    deck = createDeck();
                    shuffleDeck(deck);

                    // Reset tangan pemain sebelum membagikan kartu baru
                    players.forEach(p => p.hand = []);

                    renderAll();

                    animateDealing(() => {
                        let firstCard;
                        do {
                            firstCard = deck.pop();
                            if (firstCard.value === 'wild4') {
                                deck.push(firstCard);
                                shuffleDeck(deck);
                            }
                        } while (firstCard.value === 'wild4');

                        discardPile.push(firstCard);
                        renderAll();
                        setTimeout(() => beginFirstTurn(firstCard), 500);
                    });
                }

                function beginFirstTurn(firstCard) {
                    gameActive = true;
                    handleCardEffect(firstCard, currentPlayerIndex, true);
                }

                function endGame() {
                    gameActive = false;
                    clearTimeout(botTurnTimeout);

                    const lastPlayer = players.find(p => !p.isFinished);
                    if (lastPlayer) {
                        playerRanks.push({ id: lastPlayer.id, name: lastPlayer.name });
                    }

                    const ranksContainer = document.getElementById('end-game-ranks');
                    ranksContainer.innerHTML = '<h3>Peringkat Akhir</h3>';
                    const scorePoints = [100, 50, 25, 10];
                    playerRanks.forEach((p, i) => {
                        const score = scorePoints[i] || 0;
                        if (p.id === 0) {
                            saveHighScore(p.name, score);
                        }
                        const rankDiv = document.createElement('div');
                        rankDiv.className = 'rank-item';
                        rankDiv.innerHTML = `<span class="rank-pos">#${i + 1}</span> <span>${p.name}</span> <span class="score">${score} Poin</span>`;
                        ranksContainer.appendChild(rankDiv);
                    });
                    showScreen('endGame');
                }

                // =========================================================================
                //  PAUSE MENU
                // =========================================================================
                function togglePause() {
                    if (!gameActive) return;
                    isPaused = !isPaused;

                    const existingPauseMenu = document.getElementById('pause-menu');
                    if (existingPauseMenu) existingPauseMenu.remove();

                    if (isPaused) {
                        clearTimeout(botTurnTimeout);
                        const pauseMenu = document.createElement('div');
                        pauseMenu.id = 'pause-menu';
                        pauseMenu.className = 'popup';
                        pauseMenu.innerHTML = `
                        <h3>Jeda</h3>
                        <div class="popup-options" style="flex-direction: column;">
                            <button id="auto-mode-btn" class="menu-btn"></button>
                            <button id="resume-btn" class="menu-btn green">Teruskan</button>
                            <button id="restart-pause-btn" class="menu-btn yellow">Restart</button>
                            <button id="exit-pause-btn" class="menu-btn red">Keluar</button>
                        </div>
                    `;

                        const autoModeBtn = pauseMenu.querySelector('#auto-mode-btn');

                        const updateAutoModeButton = () => {
                            autoModeBtn.textContent = isAutoMode ? 'Auto Mode: ON' : 'Auto Mode: OFF';
                            autoModeBtn.classList.toggle('green', isAutoMode);
                            autoModeBtn.classList.toggle('blue', !isAutoMode);
                        };

                        updateAutoModeButton();

                        autoModeBtn.onclick = () => {
                            isAutoMode = !isAutoMode;
                            updateAutoModeButton();
                        };

                        screens.game.appendChild(pauseMenu);

                        // Perbaikan ada di 2 baris di bawah ini
                        pauseMenu.querySelector('#resume-btn').onclick = togglePause;
                        pauseMenu.querySelector('#restart-pause-btn').onclick = () => {
                            screens.game.removeChild(pauseMenu); // Hapus menu sebelum restart
                            startPreGame();
                        };
                        pauseMenu.querySelector('#exit-pause-btn').onclick = () => {
                            screens.game.removeChild(pauseMenu); // Hapus menu sebelum keluar
                            showScreen('mainMenu');
                        };
                    } else {
                        const currentPlayer = players.find(p => p.id === currentPlayerIndex);
                        if (isAutoMode && currentPlayer && !currentPlayer.isBot && !currentPlayer.isFinished) {
                            botTurnTimeout = setTimeout(playHumanAsBotTurn, 1000);
                        } else if (currentPlayer && currentPlayer.isBot) {
                            botTurnTimeout = setTimeout(playBotTurn, 1000);
                        }
                    }
                }

                // =========================================================================
                //  RENDER & ANIMASI
                // =========================================================================
                function createCardElement(card, isBack = false) {
                    const cardElem = document.createElement('div');
                    cardElem.className = 'card';

                    if (isBack) {
                        cardElem.classList.add('card-back');
                    } else {
                        cardElem.dataset.color = card.color;
                        cardElem.dataset.value = card.value;
                        cardElem.dataset.cardData = JSON.stringify(card);

                        let textContent = '';
                        switch (card.value) {
                            case 'skip': textContent = '🚫'; break;
                            case 'reverse': textContent = '⟲'; break;
                            case 'draw2': textContent = '+2'; break;
                            case 'wild': textContent = ''; break;
                            case 'wild4': textContent = '+4'; break;
                            default: textContent = card.value; break;
                        }
                        cardElem.textContent = textContent;
                    }
                    return cardElem;
                }

                function animateCardMove(startElem, endElem, cardData, onComplete) {
                    if (!startElem || !endElem) return; // Guard clause
                    const startRect = startElem.getBoundingClientRect();
                    const endRect = endElem.getBoundingClientRect();
                    const boardRect = screens.game.getBoundingClientRect();

                    const movingCard = createCardElement(cardData, Object.keys(cardData).length === 0);
                    movingCard.classList.add('card-animation');
                    movingCard.style.left = `${startRect.left - boardRect.left}px`;
                    movingCard.style.top = `${startRect.top - boardRect.top}px`;
                    screens.game.appendChild(movingCard);

                    requestAnimationFrame(() => {
                        movingCard.style.left = `${endRect.left - boardRect.left + (endRect.width / 4)}px`;
                        movingCard.style.top = `${endRect.top - boardRect.top + (endRect.height / 4)}px`;
                    });

                    setTimeout(() => {
                        if (screens.game.contains(movingCard)) {
                            screens.game.removeChild(movingCard);
                        }
                        if (onComplete) onComplete();
                    }, 200);
                }

                /**
                 * [FIXED] Memperbaiki logika animasi pembagian kartu.
                 * `endElemId` sekarang ditentukan secara dinamis menggunakan `playerToDeal.id`
                 * untuk menargetkan elemen visual yang benar, sesuai dengan slotnya.
                 */
                function animateDealing(onComplete) {
                    let cardsDealt = 0;
                    let playerDealIndex = 0;
                    const totalCardsToDeal = players.length * CARDS_PER_PLAYER;

                    function dealOneCard() {
                        if (cardsDealt >= totalCardsToDeal) {
                            onComplete();
                            return;
                        }

                        const playerToDeal = players[playerDealIndex];
                        if (deck.length > 0) {
                            const cardData = deck.pop();
                            playerToDeal.hand.push(cardData);
                        }

                        // FIX: Menggunakan player's ID untuk menemukan elemen tangan yang benar
                        const endElemId = playerToDeal.isBot ? `hand-bot-${playerToDeal.id}` : 'player-hand';
                        const endElem = document.getElementById(endElemId);

                        animateCardMove(deckPileElem, endElem, {}, () => {
                            renderAll();
                            playerDealIndex = (playerDealIndex + 1) % players.length;
                            cardsDealt++;
                            setTimeout(dealOneCard, 100);
                        });
                    }
                    dealOneCard();
                }

                function renderAll() {
                    if (players.length === 0) return;

                    // Render human player's hand
                    playerHandElem.innerHTML = '';
                    players[0].hand.forEach(card => {
                        const cardElem = createCardElement(card);
                        cardElem.draggable = true;
                        cardElem.addEventListener('dragstart', (ev) => {
                            if (currentPlayerIndex === 0 && gameActive && !isPaused && !players[0].isFinished) {
                                ev.dataTransfer.setData('text/plain', ev.target.dataset.cardData);
                            } else {
                                ev.preventDefault();
                            }
                        });
                        cardElem.addEventListener('touchstart', handleTouchStart, { passive: false });
                        playerHandElem.appendChild(cardElem);
                    });

                    // Render bots' hands (as card backs)
                    players.forEach(player => {
                        if (player.isBot) {
                            const botHandElem = document.getElementById(`hand-bot-${player.id}`);
                            if (botHandElem) {
                                botHandElem.innerHTML = '';
                                player.hand.forEach(() => {
                                    botHandElem.appendChild(createCardElement({}, true));
                                });
                            }
                        }
                    });

                    // Render discard pile
                    discardPileContainer.innerHTML = '';
                    const topCard = getTopCard();
                    if (topCard) {
                        const topCardElem = createCardElement(topCard);
                        topCardElem.style.cursor = 'default';
                        discardPileContainer.appendChild(topCardElem);
                    }

                    updatePlayerInfos();

                    // Handle UNO button visibility
                    const humanPlayer = players[0];
                    if (gameActive && humanPlayer && humanPlayer.hand.length === 2 && !humanPlayer.isFinished) {
                        unoButton.classList.add('visible');
                    } else {
                        unoButton.classList.remove('visible');
                    }
                    if (humanPlayer && humanPlayer.hand.length !== 2) {
                        unoCalledByPlayer = false;
                        unoButton.classList.remove('called');
                    }
                }

                /**
                 * [FIXED] Merombak total logika pemetaan info pemain.
                 * Fungsi ini sekarang memetakan setiap pemain aktif ke area visualnya yang benar
                 * dan secara akurat menerapkan kelas 'active' dan 'finished'.
                 */
                function updatePlayerInfos() {
                    if (!players || players.length === 0) return;

                    const activePlayer = players.find(p => p.id === currentPlayerIndex);

                    players.forEach((p) => {
                        // ID elemen info (info-player, info-bot-1, dll)
                        const infoId = p.isBot ? `info-bot-${p.id}` : 'info-player';
                        const infoElem = document.getElementById(infoId);

                        if (infoElem) {
                            if (p.isFinished) {
                                const rankIndex = playerRanks.findIndex(rank => rank.id === p.id);
                                infoElem.textContent = (rankIndex !== -1) ? `#${rankIndex + 1} ${p.name}` : `${p.name} (Selesai)`;
                            } else {
                                infoElem.textContent = `${p.name} (${p.hand.length})`;
                            }
                        }

                        // ID elemen area (player-area-top, player-area-left, dll)
                        let areaId;
                        if (p.id === 0) { areaId = 'bottom'; }
                        else if (p.id === 1) { areaId = 'left'; }
                        else if (p.id === 2) { areaId = 'top'; }
                        else if (p.id === 3) { areaId = 'right'; }

                        if (areaId) {
                            const areaElem = document.getElementById(`player-area-${areaId}`);
                            if (areaElem) {
                                areaElem.classList.toggle('finished', p.isFinished);
                                areaElem.classList.toggle('active', gameActive && !p.isFinished && activePlayer && p.id === activePlayer.id);
                            }
                        }
                    });
                }

                function updateGameInfo(message) {
                    if (!gameActive && message) {
                        gameInfoElem.textContent = message;
                        return;
                    }
                    const player = players.find(p => p.id === currentPlayerIndex);
                    if (!gameActive || !player) return;

                    gameInfoElem.textContent = message || (player.isFinished ? `Menunggu...` : `Giliran ${player.name}`);
                }

                // =========================================================================
                //  LOGIKA INTI PERMAINAN
                // =========================================================================
                /**
                 * [FIXED] Merombak total logika giliran pemain.
                 * Fungsi ini sekarang mencari pemain berikutnya berdasarkan posisinya di dalam
                 * array `players` yang aktif, bukan berdasarkan asumsi ID yang berurutan.
                 */
                function nextTurn() {
                    if (isPaused) return;

                    let currentPhysicalIndex = players.findIndex(p => p.id === currentPlayerIndex);
                    if (currentPhysicalIndex === -1) return; // Player not found, abort

                    let nextPlayer;
                    let guard = 0;
                    do {
                        currentPhysicalIndex = (currentPhysicalIndex + gameDirection + players.length) % players.length;
                        nextPlayer = players[currentPhysicalIndex];
                        guard++;
                    } while (nextPlayer.isFinished && guard < players.length * 2);

                    if (guard >= players.length * 2) {
                        endGame();
                        return;
                    }

                    currentPlayerIndex = nextPlayer.id;
                    updateGameInfo();
                    updatePlayerInfos();

                    players.forEach((p) => {
                        if (p.id !== currentPlayerIndex && p.hand.length === 1 && !p.unoCalled) {
                            showNotification(`${p.name} lupa bilang UNO! Ambil 2 kartu.`);
                            triggerDraw(p.id, 2);
                        }
                        if (p.hand.length > 1) p.unoCalled = false;
                    });

                    const currentPlayerObject = players.find(p => p.id === currentPlayerIndex);
                    if (currentPlayerObject && currentPlayerObject.isBot) {
                        botTurnTimeout = setTimeout(playBotTurn, 2000);
                    } else if (isAutoMode) { // Jika ini pemain manusia DAN auto mode ON
                        botTurnTimeout = setTimeout(playHumanAsBotTurn, 2000);
                    }
                }

                function playCard(playerIndex, card) {
                    const player = players.find(p => p.id === playerIndex);
                    if (!player) return;
                    const cardIndex = player.hand.findIndex(c => c.color === card.color && c.value === card.value);
                    if (cardIndex === -1) return;

                    const playedCard = player.hand.splice(cardIndex, 1)[0];
                    discardPile.push(playedCard);

                    renderAll();

                    if (player.hand.length === 0) {
                        player.isFinished = true;
                        playerRanks.push({ id: player.id, name: player.name });
                        showNotification(`${player.name} selesai! (Peringkat #${playerRanks.length})`);
                        renderAll();

                        if (playerRanks.length >= NUM_PLAYERS - 1) {
                            setTimeout(endGame, 1000);
                            return;
                        }
                    }

                    handleCardEffect(playedCard, playerIndex, false);
                }

                /**
                 * [FIXED] Memperbaiki cara target (korban) dari kartu aksi ditentukan.
                 * Sama seperti `nextTurn`, ini sekarang menggunakan array `players` yang aktif.
                 */
                function handleCardEffect(card, playerIndex, isFirstCard) {
                    let shouldAdvanceTurn = true;
                    const cardBeforePlay = discardPile[discardPile.length - 2] || null;

                    let victimId = playerIndex;
                    let guard = 0;
                    let currentPhysicalIndex = players.findIndex(p => p.id === victimId);

                    if (currentPhysicalIndex !== -1) {
                        do {
                            currentPhysicalIndex = (currentPhysicalIndex + gameDirection + players.length) % players.length;
                            victimId = players[currentPhysicalIndex].id;
                            guard++;
                        } while (players.find(p => p.id === victimId).isFinished && guard < players.length * 2);
                    }

                    switch (card.value) {
                        case 'skip':
                            showAction('🚫');
                            updateGameInfo(`Giliran ${players.find(p => p.id === victimId).name} dilewati!`);
                            currentPlayerIndex = victimId;
                            break;

                        case 'reverse':
                            if (players.filter(p => !p.isFinished).length > 2) {
                                showAction('⟲');
                                gameDirection *= -1;
                                updateDirectionIndicator();
                            }
                            break;

                        case 'draw2':
                            updateGameInfo(`${players.find(p => p.id === victimId).name} ambil 2 kartu!`);
                            shouldAdvanceTurn = false;
                            currentPlayerIndex = victimId;
                            triggerDraw(victimId, 2, () => nextTurn());
                            break;

                        case 'wild':
                            if (isFirstCard) {
                                promptChooseColor(playerIndex, () => {
                                    currentPlayerIndex = playerIndex;
                                    updateGameInfo();
                                    updatePlayerInfos();
                                    if (players.find(p => p.id === currentPlayerIndex).isBot) botTurnTimeout = setTimeout(playBotTurn, 2000);
                                });
                            } else {
                                shouldAdvanceTurn = false;
                                promptChooseColor(playerIndex, () => nextTurn());
                            }
                            break;

                        case 'wild4':
                            if (isFirstCard) break;
                            shouldAdvanceTurn = false;
                            promptChooseColor(playerIndex, (chosenColor) => {
                                promptChallenge(playerIndex, victimId, cardBeforePlay, chosenColor, () => nextTurn());
                            });
                            break;
                    }

                    if (shouldAdvanceTurn) {
                        if (isFirstCard) {
                            let firstPlayerToAct = playerIndex;
                            let firstPlayerPhysicalIndex = players.findIndex(p => p.id === firstPlayerToAct);
                            if (firstPlayerPhysicalIndex !== -1) {
                                if (card.value === 'skip') {
                                    firstPlayerPhysicalIndex = (firstPlayerPhysicalIndex + gameDirection + players.length) % players.length;
                                    firstPlayerToAct = players[firstPlayerPhysicalIndex].id;
                                } else if (card.value === 'reverse') {
                                    gameDirection *= -1;
                                    updateDirectionIndicator();
                                    firstPlayerPhysicalIndex = (firstPlayerPhysicalIndex + gameDirection + players.length) % players.length;
                                    firstPlayerToAct = players[firstPlayerPhysicalIndex].id;
                                }
                            }

                            currentPlayerIndex = firstPlayerToAct;
                            updateGameInfo();
                            updatePlayerInfos();
                            if (players.find(p => p.id === currentPlayerIndex)?.isBot) botTurnTimeout = setTimeout(playBotTurn, 2000);

                        } else {
                            nextTurn();
                        }
                    }
                }

                function promptChooseColor(playerIndex, callback) {
                    const player = players.find(p => p.id === playerIndex);
                    if (!player) return;

                    // Cek jika pemain adalah manusia dalam Auto Mode ATAU memang bot
                    if ((player.id === 0 && isAutoMode) || player.isBot) {
                        let chosenColor;
                        const nameSuffix = (player.id === 0 && isAutoMode) ? " (Auto)" : "";

                        if (botDifficulty === 'easy' && player.isBot) {
                            chosenColor = COLORS[Math.floor(Math.random() * 4)];
                        } else {
                            // Logika medium/hard/expert (termasuk untuk auto mode pemain)
                            const colorCounts = COLORS.reduce((acc, color) => {
                                acc[color] = player.hand.filter(c => c.color === color).length;
                                return acc;
                            }, {});
                            const maxCount = Math.max(...Object.values(colorCounts));
                            const bestColors = Object.keys(colorCounts).filter(color => colorCounts[color] === maxCount);
                            chosenColor = bestColors[0] || COLORS[Math.floor(Math.random() * 4)];
                        }

                        getTopCard().color = chosenColor;
                        showNotification(`${player.name}${nameSuffix} memilih warna ${chosenColor}.`);
                        renderAll();
                        if (callback) setTimeout(() => callback(chosenColor), 500);
                        return; // PENTING: Hentikan eksekusi agar pop-up tidak muncul
                    }

                    // Jika bukan auto mode, tampilkan pop-up untuk pemain manusia
                    const picker = document.createElement('div');
                    picker.id = 'color-picker';
                    picker.className = 'popup';
                    picker.innerHTML = `<h3>Pilih Warna</h3><div class="popup-options" style="flex-direction: row;"></div>`;
                    COLORS.forEach(color => {
                        const btn = document.createElement('button');
                        btn.className = 'color-btn';
                        btn.style.backgroundColor = `var(--${color})`;
                        btn.onclick = () => {
                            screens.game.removeChild(picker);
                            getTopCard().color = color;
                            renderAll();
                            if (callback) callback(color);
                        };
                        picker.querySelector('.popup-options').appendChild(btn);
                    });
                    screens.game.appendChild(picker);
                }

                function promptChallenge(attackerIndex, victimIndex, cardBeforePlay, chosenColor, onComplete) {
                    const victim = players.find(p => p.id === victimIndex);
                    const attacker = players.find(p => p.id === attackerIndex);
                    if (!victim || !attacker) return;

                    // Fungsi resolve yang akan dipanggil nanti
                    function resolveChallenge(didChallenge) {
                        if (!didChallenge) {
                            updateGameInfo(`${victim.name} ambil 4 kartu.`);
                            currentPlayerIndex = victimIndex;
                            triggerDraw(victimIndex, 4, onComplete);
                            return;
                        }

                        const wasIllegal = cardBeforePlay ? attacker.hand.some(c => c.color === cardBeforePlay.color || c.value === cardBeforePlay.value) : false;

                        if (wasIllegal) {
                            showNotification(`Tantangan Berhasil! ${attacker.name} ambil 4 kartu.`);
                            triggerDraw(attackerIndex, 4, () => {
                                currentPlayerIndex = victimIndex;
                                if (onComplete) onComplete();
                            });
                        } else {
                            showNotification(`Tantangan Gagal! ${victim.name} ambil 6 kartu.`);
                            currentPlayerIndex = victimIndex;
                            triggerDraw(victimIndex, 6, onComplete);
                        }
                    }

                    // Cek jika korban adalah manusia dalam Auto Mode ATAU memang bot
                    if ((victim.id === 0 && isAutoMode) || victim.isBot) {
                        const nameSuffix = (victim.id === 0 && isAutoMode) ? " (Auto)" : "";
                        const shouldChallenge = victim.isBot ? Math.random() < 0.3 : false; // Auto mode manusia tidak pernah menantang

                        if (!shouldChallenge) {
                            showNotification(`${victim.name}${nameSuffix} memilih untuk tidak menantang.`);
                        }

                        setTimeout(() => resolveChallenge(shouldChallenge), 500);
                        return; // PENTING: Hentikan eksekusi agar pop-up tidak muncul
                    }

                    // Jika bukan auto mode, tampilkan pop-up untuk pemain manusia
                    const popup = document.createElement('div');
                    popup.id = 'challenge-popup';
                    popup.className = 'popup';
                    popup.innerHTML = `
                    <h3>Anda Terkena +4!</h3>
                    <p>${attacker.name} memilih warna <strong>${chosenColor}</strong>. Tantang?</p>
                    <div class="popup-options" style="flex-direction: row;">
                        <button id="ch-no" class="menu-btn green">Terima (Ambil 4)</button>
                        <button id="ch-yes" class="menu-btn red">Tantang!</button>
                    </div>`;
                    popup.querySelector('#ch-no').onclick = () => { screens.game.removeChild(popup); resolveChallenge(false); };
                    popup.querySelector('#ch-yes').onclick = () => { screens.game.removeChild(popup); resolveChallenge(true); };
                    screens.game.appendChild(popup);
                }


                function drawCardLogic(playerIndex, amount = 1) {
                    const player = players.find(p => p.id === playerIndex);
                    if (!player) return;
                    for (let i = 0; i < amount; i++) {
                        if (deck.length === 0) {
                            if (discardPile.length <= 1) {
                                showNotification('Tidak ada kartu lagi untuk diambil!');
                                return;
                            }
                            const topCard = discardPile.pop();
                            deck = discardPile.splice(0, discardPile.length);
                            shuffleDeck(deck);
                            discardPile = [topCard];
                            showNotification('Dek dikocok ulang!');
                        }
                        if (deck.length > 0) {
                            player.hand.push(deck.pop());
                        }
                    }
                }

                function triggerDraw(playerIndex, amount = 1, onCompleteAll) {
                    let drawnCount = 0;
                    function drawOne() {
                        if (drawnCount >= amount) {
                            renderAll();
                            if (onCompleteAll) onCompleteAll();
                            return;
                        }

                        const player = players.find(p => p.id === playerIndex);
                        if (!player) return;
                        const endElemId = player.isBot ? `hand-bot-${player.id}` : 'player-hand';
                        const endElem = document.getElementById(endElemId);

                        animateCardMove(deckPileElem, endElem, {}, () => {
                            drawCardLogic(playerIndex, 1);
                            renderAll();
                            drawnCount++;
                            setTimeout(drawOne, 100);
                        });
                    }
                    drawOne();
                }

                function playBotTurn() {
                    const bot = players.find(p => p.id === currentPlayerIndex);
                    if (!gameActive || isPaused || !bot || bot.isFinished) return;

                    const topCard = getTopCard();
                    let cardToPlay = getBotMove(bot, topCard);

                    if (bot.hand.length === 2 && cardToPlay) {
                        showNotification(`${bot.name} bilang UNO!`);
                        bot.unoCalled = true;
                    }

                    if (cardToPlay) {
                        const botHandContainer = document.getElementById(`hand-bot-${bot.id}`);
                        const startAnimationElem = botHandContainer.querySelector('.card:last-child') || botHandContainer;
                        animateCardMove(startAnimationElem, discardPileContainer, cardToPlay, () => playCard(currentPlayerIndex, cardToPlay));
                    } else {
                        triggerDraw(currentPlayerIndex, 1, () => {
                            const newCard = bot.hand[bot.hand.length - 1];
                            if (isValidMove(newCard, topCard)) {
                                setTimeout(() => {
                                    const botHandContainer = document.getElementById(`hand-bot-${bot.id}`);
                                    const startAnimationElem = botHandContainer.querySelector('.card:last-child') || botHandContainer;
                                    animateCardMove(startAnimationElem, discardPileContainer, newCard, () => playCard(currentPlayerIndex, newCard));
                                }, 500);
                            } else {
                                nextTurn();
                            }
                        });
                    }
                }

                function getBotMove(bot, topCard) {
                    const hand = bot.hand;
                    const playableCards = hand.filter(card => isValidMove(card, topCard));
                    if (playableCards.length === 0) return null;

                    switch (botDifficulty) {
                        case 'easy':
                            return playableCards[0];

                        case 'medium':
                            const numberCards = playableCards.filter(c => !isNaN(parseInt(c.value)));
                            if (numberCards.length > 0) return numberCards[0];
                            return playableCards[0];

                        case 'hard':
                            const nextPlayerPhysicalIndex = (players.findIndex(p => p.id === bot.id) + gameDirection + players.length) % players.length;
                            const nextPlayer = players[nextPlayerPhysicalIndex];
                            if (nextPlayer.hand.length <= 2) {
                                const draw2Card = playableCards.find(c => c.value === 'draw2');
                                if (draw2Card) return draw2Card;
                                const skipCard = playableCards.find(c => c.value === 'skip');
                                if (skipCard) return skipCard;
                            }
                            const sortedByValue = playableCards
                                .filter(c => !isNaN(parseInt(c.value)))
                                .sort((a, b) => parseInt(b.value) - parseInt(a.value));
                            if (sortedByValue.length > 0) return sortedByValue[0];
                            return playableCards[0];

                        case 'expert':
                            const opponentToBlock = players.find(p => p.hand.length <= 2 && !p.isBot); // Target human player
                            if (opponentToBlock) {
                                const wild4 = playableCards.find(c => c.value === 'wild4');
                                if (wild4) return wild4;
                                const draw2 = playableCards.find(c => c.value === 'draw2');
                                if (draw2) return draw2;
                                const skip = playableCards.find(c => c.value === 'skip');
                                if (skip) return skip;
                            }
                            const highValueCards = playableCards
                                .filter(c => !isNaN(parseInt(c.value)))
                                .sort((a, b) => parseInt(b.value) - parseInt(a.value));
                            if (highValueCards.length > 0) return highValueCards[0];
                            return playableCards[0];
                    }
                }

                function playHumanAsBotTurn() {
                    if (!gameActive || isPaused || !isAutoMode) return;

                    const humanPlayer = players.find(p => p.id === 0);
                    if (!humanPlayer || humanPlayer.isFinished) return;

                    const topCard = getTopCard();

                    // Gunakan logika bot "medium" untuk menentukan langkah terbaik
                    const tempDifficulty = botDifficulty;
                    botDifficulty = 'medium';
                    let cardToPlay = getBotMove(humanPlayer, topCard);
                    botDifficulty = tempDifficulty; // Kembalikan ke difficulty asli

                    // Otomatis tekan tombol "UNO!" jika perlu
                    if (humanPlayer.hand.length === 2 && cardToPlay) {
                        unoCalledByPlayer = true;
                        players[0].unoCalled = true;
                        unoButton.classList.add('called');
                        showNotification("UNO!");
                    }

                    if (cardToPlay) {
                        // Animasikan kartu yang akan dimainkan
                        const cardElemToAnimate = Array.from(playerHandElem.children).find(el => {
                            try {
                                const elData = JSON.parse(el.dataset.cardData);
                                return elData.color === cardToPlay.color && elData.value === cardToPlay.value;
                            } catch (e) { return false; }
                        });
                        animateCardMove(cardElemToAnimate || playerHandElem, discardPileContainer, cardToPlay, () => playCard(0, cardToPlay));
                    } else {
                        // Jika tidak ada kartu, ambil satu
                        triggerDraw(0, 1, () => {
                            const newCard = humanPlayer.hand[humanPlayer.hand.length - 1];
                            if (isValidMove(newCard, topCard)) {
                                // Jika kartu baru bisa dimainkan, mainkan setelah jeda singkat
                                setTimeout(() => {
                                    const cardElemToAnimate = playerHandElem.lastChild;
                                    animateCardMove(cardElemToAnimate, discardPileContainer, newCard, () => playCard(0, newCard));
                                }, 1000);
                            } else {
                                nextTurn(); // Jika tidak bisa, lanjutkan ke giliran berikutnya
                            }
                        });
                    }
                }

                // =========================================================================
                //  TOUCH DRAG & DROP HANDLERS
                // =========================================================================
                function handleTouchStart(e) {
                    if (currentPlayerIndex !== 0 || !gameActive || isPaused || players[0].isFinished) return;
                    e.preventDefault();

                    const currentCard = e.target.closest('.card');
                    if (!currentCard) return;

                    // Jika kartu yang sama disentuh lagi, mulai proses drag.
                    if (touchedCardElement === currentCard) {
                        draggedElement = currentCard;
                        draggedCardData = draggedElement.dataset.cardData;

                        ghostCard = draggedElement.cloneNode(true);
                        ghostCard.style.position = 'absolute';
                        ghostCard.style.zIndex = '3000';
                        ghostCard.style.pointerEvents = 'none';
                        document.body.appendChild(ghostCard);
                        updateGhostCardPosition(e.touches[0]);

                        // Tambahkan listener HANYA saat drag dimulai.
                        document.addEventListener('touchmove', handleTouchMove, { passive: false });
                        document.addEventListener('touchend', handleTouchEnd);
                        return;
                    }

                    // Jika ada kartu lain yang sedang dipilih, batalkan pilihan itu.
                    if (touchedCardElement) {
                        touchedCardElement.classList.remove('selected');
                    }

                    // Pilih kartu yang baru disentuh.
                    touchedCardElement = currentCard;
                    touchedCardElement.classList.add('selected');
                }

                function handleTouchMove(e) {
                    // Fungsi ini hanya aktif jika drag sudah dimulai dari handleTouchStart.
                    e.preventDefault();
                    if (!ghostCard) return;

                    const touch = e.touches[0];
                    updateGhostCardPosition(touch);
                    const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropZone = elementUnderTouch ? elementUnderTouch.closest('#discard-pile-container') : null;
                    discardPileContainer.classList.toggle('drag-over', !!dropZone);
                }

                function handleTouchEnd(e) {
                    // Fungsi ini juga hanya aktif setelah drag dimulai.
                    if (!ghostCard) return;

                    const touch = e.changedTouches[0];
                    const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (elementUnderTouch && elementUnderTouch.closest('#discard-pile-container')) {
                        handleDropLogic(draggedCardData);
                    }

                    // Hapus ghost card dan batalkan pilihan kartu setelah drop.
                    document.body.removeChild(ghostCard);
                    if (touchedCardElement) {
                        touchedCardElement.classList.remove('selected');
                    }
                    discardPileContainer.classList.remove('drag-over');

                    // Hapus listener dan reset semua variabel terkait drag.
                    document.removeEventListener('touchmove', handleTouchMove);
                    document.removeEventListener('touchend', handleTouchEnd); // Menghapus dirinya sendiri
                    ghostCard = null;
                    draggedElement = null;
                    draggedCardData = null;
                    touchedCardElement = null; // Reset kartu yang dipilih
                }

                function updateGhostCardPosition(touch) {
                    if (!ghostCard) return;
                    ghostCard.style.left = `${touch.clientX - ghostCard.offsetWidth / 2}px`;
                    ghostCard.style.top = `${touch.clientY - ghostCard.offsetHeight / 2}px`;
                }

                // (GANTI DENGAN INI) Fungsi untuk menampilkan pop-up konfirmasi keluar (VERSI FINAL)
                function showExitConfirmation() {
                    // Mencegah pop-up ganda jika tombol diklik berkali-kali
                    if (document.getElementById('exit-confirmation-popup')) return;

                    const popup = document.createElement('div');
                    popup.id = 'exit-confirmation-popup';
                    // Gunakan class .popup yang sudah ada agar stylenya sama
                    popup.className = 'popup';
                    popup.innerHTML = `
            <h3>Konfirmasi Keluar</h3>
            <p style="margin-bottom: 20px; font-size: 1rem; text-align: center;">Apakah yakin ingin keluar?</p>
            <div class="popup-options">
                <button id="exit-confirm-yes" class="menu-btn red">Ya</button>
                <button id="exit-confirm-no" class="menu-btn green">Tidak</button>
            </div>`;

                    // (PERBAIKAN UTAMA) Tampilkan pop-up di atas BODY agar selalu terlihat
                    document.body.appendChild(popup);

                    // Tambahkan fungsi untuk tombol "Ya"
                    document.getElementById('exit-confirm-yes').onclick = () => {
                        // Perintah ini akan mencoba menutup tab/jendela
                        window.close();
                        // Jika window.close() gagal (karena diblokir browser), hapus pop-up
                        if (document.body.contains(popup)) {
                            document.body.removeChild(popup);
                        }
                    };

                    // Tambahkan fungsi untuk tombol "Tidak"
                    document.getElementById('exit-confirm-no').onclick = () => {
                        document.body.removeChild(popup);
                    };
                }

                // =========================================================================
                //  EVENT LISTENERS
                // =========================================================================
                deckPileElem.addEventListener('click', () => {
                    if (currentPlayerIndex === 0 && gameActive && !isPaused && !players[0].isFinished) {
                        if (playerHasValidMove(0)) {
                            showNotification("Anda memiliki kartu yang bisa dimainkan!");
                            return;
                        }
                        triggerDraw(0, 1, () => {
                            const newCard = players[0].hand[players[0].hand.length - 1];
                            if (!isValidMove(newCard, getTopCard())) {
                                nextTurn();
                            } else {
                                showNotification("Anda bisa memainkan kartu yang baru diambil.");
                            }
                        });
                    }
                });

                discardPileContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (currentPlayerIndex === 0 && gameActive && !isPaused && !players[0].isFinished) {
                        discardPileContainer.classList.add('drag-over');
                    }
                });

                discardPileContainer.addEventListener('dragleave', () => {
                    discardPileContainer.classList.remove('drag-over');
                });

                function handleDropLogic(cardDataString) {
                    if (!cardDataString) return;
                    try {
                        const card = JSON.parse(cardDataString);
                        if (isValidMove(card, getTopCard())) {
                            if (players[0].hand.length === 2 && !unoCalledByPlayer) {
                                showNotification("Lupa tekan UNO! Ambil 2 kartu.");
                                triggerDraw(0, 2);
                            }
                            playCard(0, card);
                        } else {
                            showNotification("Kartu tidak cocok!");
                        }
                    } catch (err) {
                        console.error("Error parsing dropped card data:", err);
                    }
                }

                discardPileContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    discardPileContainer.classList.remove('drag-over');
                    if (currentPlayerIndex !== 0 || !gameActive || isPaused || players[0].isFinished) return;
                    const cardData = e.dataTransfer.getData('text/plain');
                    handleDropLogic(cardData);
                });

                unoButton.addEventListener('click', () => {
                    if (gameActive && !isPaused && players.find(p => p.id === 0)?.hand.length === 2) {
                        unoCalledByPlayer = true;
                        players[0].unoCalled = true;
                        unoButton.classList.add('called');
                        showNotification("UNO!");
                    }
                });

                screens.game.addEventListener('touchstart', (e) => {
                    // Jika ada kartu yang dipilih DAN sentuhan terjadi di luar elemen .card
                    if (touchedCardElement && !e.target.closest('.card')) {
                        touchedCardElement.classList.remove('selected');
                        touchedCardElement = null;
                    }
                }, true); // `true` menggunakan capture phase, lebih andal untuk kasus ini.

                // =========================================================================
                //  INISIALISASI GAME
                // =========================================================================
                initMenus();
                startSplashAnimation();
            });
        </script>
</body>

</html>
